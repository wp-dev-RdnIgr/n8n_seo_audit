{
  "name": "PageSpeed Test",
  "nodes": [
    {
      "parameters": {
        "content": "## ‚ö° PageSpeed Test Workflow\n\n**Endpoint:** `POST /webhook/pagespeed-test`\n\n**–í—Ö–æ–¥:** spreadsheetId —Å URLs –≤ –∫–æ–ª–æ–Ω–∫–µ A\n**–í—ã—Ö–æ–¥:** —Ç–∞–±–ª–∏—Ü–∞ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ PageSpeed\n\n**API:** Google PageSpeed Insights v5\n**–ë–∞—Ç—á–∏–Ω–≥:** –ø–æ 5 URLs, –ø–∞—É–∑–∞ 5 —Å–µ–∫\n\n**‚ö†Ô∏è –ù–ê–°–¢–†–û–ô–ö–ê:**\n1. –ó–∞–º–µ–Ω–∏—Ç–µ `YOUR_PAGESPEED_API_KEY` –≤ –Ω–æ–¥–µ Set Variables\n2. –ü–æ–ª—É—á–∏—Ç—å –∫–ª—é—á: console.cloud.google.com ‚Üí APIs ‚Üí Credentials",
        "height": 240,
        "width": 340
      },
      "id": "sticky-main",
      "name": "Sticky Note",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [-200, -100]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "pagespeed-test",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "node-webhook",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [-180, 300],
      "webhookId": "pagespeed-test"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "sourceSpreadsheetId",
              "name": "sourceSpreadsheetId",
              "value": "={{ $json.body.spreadsheetId || $json.body.url?.match(/\\/d\\/([a-zA-Z0-9_-]+)/)?.[1] || '' }}",
              "type": "string"
            },
            {
              "id": "testMobile",
              "name": "testMobile",
              "value": "={{ $json.body.testMobile !== false }}",
              "type": "boolean"
            },
            {
              "id": "testDesktop",
              "name": "testDesktop",
              "value": "={{ $json.body.testDesktop !== false }}",
              "type": "boolean"
            },
            {
              "id": "batchSize",
              "name": "batchSize",
              "value": "={{ $json.body.batchSize || 5 }}",
              "type": "number"
            },
            {
              "id": "delaySeconds",
              "name": "delaySeconds",
              "value": "={{ $json.body.delaySeconds || 5 }}",
              "type": "number"
            },
            {
              "id": "startTime",
              "name": "startTime",
              "value": "={{ Date.now() }}",
              "type": "number"
            },
            {
              "id": "apiKey",
              "name": "apiKey",
              "value": "={{ $json.body.apiKey || 'AIzaSyANhdoZFJJj6aa5d_GQIokvgm5VExL_2ys' }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "node-set-vars",
      "name": "Set Variables",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [60, 300]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "=https://sheets.googleapis.com/v4/spreadsheets/{{ $json.sourceSpreadsheetId }}/values/A:A?majorDimension=COLUMNS",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "googleSheetsOAuth2Api",
        "options": {}
      },
      "id": "node-read-urls",
      "name": "Read Source URLs",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [300, 300],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "hMp9ISVYVcdpImYl",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Parse and validate URLs from sheet\nconst values = $input.first().json.values || [];\nconst column = values[0] || [];\nconst urls = column.slice(1) // skip header\n  .filter(url => url && url.trim())\n  .filter(url => /^https?:\\/\\//i.test(url.trim()))\n  .map(url => url.trim());\n\nconst batchSize = parseInt($('Set Variables').first().json.batchSize) || 5;\nconst batches = [];\nfor (let i = 0; i < urls.length; i += batchSize) {\n  batches.push(urls.slice(i, i + batchSize));\n}\n\nreturn [{\n  json: {\n    allUrls: urls,\n    batches: batches,\n    totalUrls: urls.length,\n    totalBatches: batches.length,\n    currentBatch: 0,\n    allResults: [],\n    testMobile: $('Set Variables').first().json.testMobile,\n    testDesktop: $('Set Variables').first().json.testDesktop,\n    startTime: $('Set Variables').first().json.startTime\n  }\n}];"
      },
      "id": "node-parse-urls",
      "name": "Parse URLs",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [540, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://sheets.googleapis.com/v4/spreadsheets",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "googleSheetsOAuth2Api",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"properties\": {\n    \"title\": \"PageSpeed Report - {{ $now.format('yyyy-MM-dd HH:mm') }}\"\n  },\n  \"sheets\": [\n    {\"properties\": {\"title\": \"Mobile Results\", \"sheetId\": 0}},\n    {\"properties\": {\"title\": \"Desktop Results\", \"sheetId\": 1}},\n    {\"properties\": {\"title\": \"Comparison\", \"sheetId\": 2}},\n    {\"properties\": {\"title\": \"Recommendations\", \"sheetId\": 3}}\n  ]\n}",
        "options": {}
      },
      "id": "node-create-sheet",
      "name": "Create Result Sheet",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [780, 300],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "hMp9ISVYVcdpImYl",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Merge create sheet result with parsed data\nconst sheetResult = $input.first().json;\nconst parsedData = $('Parse URLs').first().json;\n\nreturn [{\n  json: {\n    ...parsedData,\n    spreadsheetId: sheetResult.spreadsheetId\n  }\n}];"
      },
      "id": "node-merge-init",
      "name": "Merge Init Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1020, 300]
    },
    {
      "parameters": {
        "jsCode": "// Get state from previous iteration or initial\nlet state;\ntry {\n  state = $('Merge Batch Results').first().json;\n} catch(e) {\n  state = $('Merge Init Data').first().json;\n}\n\nconst batch = state.batches[state.currentBatch] || [];\nreturn [{ json: { ...state, currentUrls: batch } }];"
      },
      "id": "node-process-batch",
      "name": "Process Current Batch",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1260, 300]
    },
    {
      "parameters": {
        "jsCode": "// Split current batch into individual items for API calls\nconst state = $input.first().json;\nreturn state.currentUrls.map(url => ({ json: { ...state, currentUrl: url } }));"
      },
      "id": "node-split-items",
      "name": "Split to Items",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1500, 300]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "=https://www.googleapis.com/pagespeedonline/v5/runPagespeed?url={{ encodeURIComponent($json.currentUrl) }}&strategy=mobile&category=performance&category=accessibility&category=best-practices&category=seo&key={{ $('Set Variables').first().json.apiKey }}",
        "authentication": "none",
        "options": {
          "timeout": 120000
        }
      },
      "id": "node-pagespeed-mobile",
      "name": "PageSpeed Mobile",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [1740, 200],
      "continueOnFail": true
    },
    {
      "parameters": {
        "method": "GET",
        "url": "=https://www.googleapis.com/pagespeedonline/v5/runPagespeed?url={{ encodeURIComponent($json.currentUrl) }}&strategy=desktop&category=performance&category=accessibility&category=best-practices&category=seo&key={{ $('Set Variables').first().json.apiKey }}",
        "authentication": "none",
        "options": {
          "timeout": 120000
        }
      },
      "id": "node-pagespeed-desktop",
      "name": "PageSpeed Desktop",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [1740, 400],
      "continueOnFail": true
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "id": "node-merge-results",
      "name": "Merge Mobile Desktop",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.1,
      "position": [1980, 300]
    },
    {
      "parameters": {
        "jsCode": "// Parse PageSpeed results for each URL\nfunction parseMetrics(response, url) {\n  if (!response || response.error) {\n    return {\n      url: url,\n      error: response?.error?.message || 'Request failed',\n      performance: null,\n      accessibility: null,\n      bestPractices: null,\n      seo: null,\n      fcp: null,\n      lcp: null,\n      tbt: null,\n      cls: null,\n      speedIndex: null,\n      tti: null,\n      fcpDisplay: 'Error',\n      lcpDisplay: 'Error',\n      tbtDisplay: 'Error',\n      clsDisplay: 'Error',\n      recommendations: []\n    };\n  }\n  \n  const lighthouse = response.lighthouseResult;\n  const audits = lighthouse?.audits || {};\n  const categories = lighthouse?.categories || {};\n  \n  return {\n    url: url,\n    performance: Math.round((categories?.performance?.score || 0) * 100),\n    accessibility: Math.round((categories?.accessibility?.score || 0) * 100),\n    bestPractices: Math.round((categories?.['best-practices']?.score || 0) * 100),\n    seo: Math.round((categories?.seo?.score || 0) * 100),\n    \n    // Core Web Vitals (raw values in ms)\n    fcp: audits?.['first-contentful-paint']?.numericValue || null,\n    lcp: audits?.['largest-contentful-paint']?.numericValue || null,\n    tbt: audits?.['total-blocking-time']?.numericValue || null,\n    cls: audits?.['cumulative-layout-shift']?.numericValue || null,\n    \n    // Additional metrics\n    speedIndex: audits?.['speed-index']?.numericValue || null,\n    tti: audits?.['interactive']?.numericValue || null,\n    \n    // Display values (formatted strings)\n    fcpDisplay: audits?.['first-contentful-paint']?.displayValue || 'N/A',\n    lcpDisplay: audits?.['largest-contentful-paint']?.displayValue || 'N/A',\n    tbtDisplay: audits?.['total-blocking-time']?.displayValue || 'N/A',\n    clsDisplay: audits?.['cumulative-layout-shift']?.displayValue || 'N/A',\n    speedIndexDisplay: audits?.['speed-index']?.displayValue || 'N/A',\n    ttiDisplay: audits?.['interactive']?.displayValue || 'N/A',\n    \n    // Recommendations (opportunities with savings)\n    recommendations: Object.values(audits)\n      .filter(a => a.score !== null && a.score < 0.9 && a.details?.type === 'opportunity')\n      .sort((a, b) => (b.numericValue || 0) - (a.numericValue || 0))\n      .slice(0, 5)\n      .map(a => a.title)\n  };\n}\n\nconst items = $input.all();\nconst batchResults = [];\n\n// Each item has mobile and desktop results merged by position\nfor (const item of items) {\n  const url = item.json.currentUrl;\n  const mobileData = item.json;\n  \n  // Find corresponding desktop result\n  // Since we merged by position, mobile is in main json, desktop should be in paired data\n  const desktopItem = items.find(i => i.json.currentUrl === url && i !== item);\n  const desktopData = desktopItem?.json || {};\n  \n  batchResults.push({\n    url: url,\n    mobile: parseMetrics(mobileData.lighthouseResult ? mobileData : null, url),\n    desktop: parseMetrics(desktopData.lighthouseResult ? desktopData : null, url)\n  });\n}\n\n// Get state from first item\nconst state = $('Process Current Batch').first().json;\n\nreturn [{ json: { ...state, batchResults: batchResults } }];"
      },
      "id": "node-parse-results",
      "name": "Parse Results",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2220, 300]
    },
    {
      "parameters": {
        "jsCode": "// Merge Mobile and Desktop results with URLs from API response\nconst state = $('Process Current Batch').first().json;\nconst mobileResults = $('PageSpeed Mobile').all();\nconst desktopResults = $('PageSpeed Desktop').all();\n\n// Parse results - extract URL from API response\nconst batchResults = [];\nconst processedUrls = new Set();\n\nfor (let i = 0; i < Math.max(mobileResults.length, desktopResults.length); i++) {\n  const mobileData = mobileResults[i]?.json;\n  const desktopData = desktopResults[i]?.json;\n  \n  // Extract URL from API response (lighthouseResult.requestedUrl or lighthouseResult.finalUrl)\n  const url = mobileData?.lighthouseResult?.requestedUrl || \n              mobileData?.lighthouseResult?.finalUrl ||\n              desktopData?.lighthouseResult?.requestedUrl ||\n              desktopData?.lighthouseResult?.finalUrl ||\n              state.currentUrls[i] || \n              'Unknown URL';\n  \n  if (processedUrls.has(url)) continue;\n  processedUrls.add(url);\n  \n  function parseMetrics(response) {\n    if (!response || response.error || !response.lighthouseResult) {\n      return {\n        error: response?.error?.message || 'Failed',\n        performance: null,\n        accessibility: null,\n        bestPractices: null,\n        seo: null,\n        fcpDisplay: 'Error',\n        lcpDisplay: 'Error',\n        tbtDisplay: 'Error',\n        clsDisplay: 'Error',\n        speedIndexDisplay: 'Error',\n        ttiDisplay: 'Error',\n        recommendations: []\n      };\n    }\n    \n    const lighthouse = response.lighthouseResult;\n    const audits = lighthouse?.audits || {};\n    const categories = lighthouse?.categories || {};\n    \n    return {\n      performance: Math.round((categories?.performance?.score || 0) * 100),\n      accessibility: Math.round((categories?.accessibility?.score || 0) * 100),\n      bestPractices: Math.round((categories?.['best-practices']?.score || 0) * 100),\n      seo: Math.round((categories?.seo?.score || 0) * 100),\n      fcpDisplay: audits?.['first-contentful-paint']?.displayValue || 'N/A',\n      lcpDisplay: audits?.['largest-contentful-paint']?.displayValue || 'N/A',\n      tbtDisplay: audits?.['total-blocking-time']?.displayValue || 'N/A',\n      clsDisplay: audits?.['cumulative-layout-shift']?.displayValue || 'N/A',\n      speedIndexDisplay: audits?.['speed-index']?.displayValue || 'N/A',\n      ttiDisplay: audits?.['interactive']?.displayValue || 'N/A',\n      recommendations: Object.values(audits)\n        .filter(a => a.score !== null && a.score < 0.9 && a.details?.type === 'opportunity')\n        .slice(0, 5)\n        .map(a => a.title)\n    };\n  }\n  \n  batchResults.push({\n    url: url,\n    mobile: parseMetrics(mobileData),\n    desktop: parseMetrics(desktopData)\n  });\n}\n\n// Merge with previous results\nconst allResults = [...(state.allResults || []), ...batchResults];\nconst nextBatch = state.currentBatch + 1;\nconst hasMore = nextBatch < state.totalBatches;\n\nreturn [{\n  json: {\n    ...state,\n    allResults: allResults,\n    currentBatch: nextBatch,\n    hasMore: hasMore,\n    progress: Math.round((nextBatch / state.totalBatches) * 100)\n  }\n}];"
      },
      "id": "node-merge-batch",
      "name": "Merge Batch Results",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2460, 300]
    },
    {
      "parameters": {
        "conditions": {
          "options": { "caseSensitive": true, "leftValue": "" },
          "conditions": [
            {
              "id": "hasMore",
              "leftValue": "={{ $json.hasMore }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        }
      },
      "id": "node-has-more",
      "name": "Has More Batches?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [2700, 300]
    },
    {
      "parameters": {
        "amount": 5,
        "unit": "seconds"
      },
      "id": "node-wait",
      "name": "Wait",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [2940, 200]
    },
    {
      "parameters": {
        "jsCode": "// Format final results for writing to sheets\nconst state = $input.first().json;\nconst results = state.allResults || [];\n\n// Explanation rows (descriptions for each column)\nconst mobileExplanation = [\n  '–ê–¥—Ä–µ—Å–∞ —Å—Ç–æ—Ä—ñ–Ω–∫–∏',\n  '–ó–∞–≥–∞–ª—å–Ω–∞ –æ—Ü—ñ–Ω–∫–∞ 0-100',\n  'First Contentful Paint - —á–∞—Å –¥–æ –ø–µ—Ä—à–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç—É',\n  'Largest Contentful Paint - —á–∞—Å –¥–æ –Ω–∞–π–±—ñ–ª—å—à–æ–≥–æ –µ–ª–µ–º–µ–Ω—Ç—É',\n  'Total Blocking Time - —á–∞—Å –±–ª–æ–∫—É–≤–∞–Ω–Ω—è',\n  'Cumulative Layout Shift - –∑–º—ñ—â–µ–Ω–Ω—è –º–∞–∫–µ—Ç—É',\n  '–®–≤–∏–¥–∫—ñ—Å—Ç—å –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∫–æ–Ω—Ç–µ–Ω—Ç—É',\n  'Time to Interactive - —á–∞—Å –¥–æ —ñ–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ',\n  '–û—Ü—ñ–Ω–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—ñ 0-100',\n  '–ö—Ä–∞—â—ñ –ø—Ä–∞–∫—Ç–∏–∫–∏ 0-100',\n  'SEO –æ—Ü—ñ–Ω–∫–∞ 0-100'\n];\n\nconst comparisonExplanation = [\n  '–ê–¥—Ä–µ—Å–∞ —Å—Ç–æ—Ä—ñ–Ω–∫–∏',\n  '–û—Ü—ñ–Ω–∫–∞ Mobile',\n  '–û—Ü—ñ–Ω–∫–∞ Desktop',\n  '–†—ñ–∑–Ω–∏—Ü—è (Desktop - Mobile)',\n  'LCP Mobile',\n  'LCP Desktop',\n  'CLS Mobile',\n  'CLS Desktop'\n];\n\nconst recsExplanation = [\n  '–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—è –≤—ñ–¥ Google PageSpeed',\n  '–ö—ñ–ª—å–∫—ñ—Å—Ç—å URL –∑ —Ü—ñ—î—é –ø—Ä–æ–±–ª–µ–º–æ—é'\n];\n\n// Mobile Results Sheet\nconst mobileRows = [\n  ['URL', 'Performance', 'FCP', 'LCP', 'TBT', 'CLS', 'Speed Index', 'TTI', 'Accessibility', 'Best Practices', 'SEO'],\n  mobileExplanation,\n  ...results.map(r => [\n    r.url,\n    r.mobile.error ? 'Error' : r.mobile.performance,\n    r.mobile.fcpDisplay,\n    r.mobile.lcpDisplay,\n    r.mobile.tbtDisplay,\n    r.mobile.clsDisplay,\n    r.mobile.speedIndexDisplay,\n    r.mobile.ttiDisplay,\n    r.mobile.accessibility || 'N/A',\n    r.mobile.bestPractices || 'N/A',\n    r.mobile.seo || 'N/A'\n  ])\n];\n\n// Desktop Results Sheet\nconst desktopRows = [\n  ['URL', 'Performance', 'FCP', 'LCP', 'TBT', 'CLS', 'Speed Index', 'TTI', 'Accessibility', 'Best Practices', 'SEO'],\n  mobileExplanation,\n  ...results.map(r => [\n    r.url,\n    r.desktop.error ? 'Error' : r.desktop.performance,\n    r.desktop.fcpDisplay,\n    r.desktop.lcpDisplay,\n    r.desktop.tbtDisplay,\n    r.desktop.clsDisplay,\n    r.desktop.speedIndexDisplay,\n    r.desktop.ttiDisplay,\n    r.desktop.accessibility || 'N/A',\n    r.desktop.bestPractices || 'N/A',\n    r.desktop.seo || 'N/A'\n  ])\n];\n\n// Comparison Sheet\nconst comparisonRows = [\n  ['URL', 'Mobile Perf', 'Desktop Perf', 'Diff', 'Mobile LCP', 'Desktop LCP', 'Mobile CLS', 'Desktop CLS'],\n  comparisonExplanation,\n  ...results.map(r => {\n    const mobilePerf = r.mobile.performance || 0;\n    const desktopPerf = r.desktop.performance || 0;\n    const diff = desktopPerf - mobilePerf;\n    return [\n      r.url,\n      mobilePerf || 'N/A',\n      desktopPerf || 'N/A',\n      diff > 0 ? '+' + diff : diff,\n      r.mobile.lcpDisplay,\n      r.desktop.lcpDisplay,\n      r.mobile.clsDisplay,\n      r.desktop.clsDisplay\n    ];\n  })\n];\n\n// Recommendations Sheet (aggregated)\nconst recsMap = new Map();\nresults.forEach(r => {\n  const allRecs = [...(r.mobile.recommendations || []), ...(r.desktop.recommendations || [])];\n  allRecs.forEach(rec => {\n    recsMap.set(rec, (recsMap.get(rec) || 0) + 1);\n  });\n});\n\nconst recommendationsRows = [\n  ['Recommendation', 'Affected URLs Count'],\n  recsExplanation,\n  ...Array.from(recsMap.entries())\n    .sort((a, b) => b[1] - a[1])\n    .map(([rec, count]) => [rec, count])\n];\n\n// Prepare data summaries for AI analysis\nconst avgMobilePerf = results.length > 0 ? Math.round(results.reduce((sum, r) => sum + (r.mobile.performance || 0), 0) / results.length) : 0;\nconst avgDesktopPerf = results.length > 0 ? Math.round(results.reduce((sum, r) => sum + (r.desktop.performance || 0), 0) / results.length) : 0;\n\nconst mobileSummary = results.map(r => `${r.url}: Performance=${r.mobile.performance}, LCP=${r.mobile.lcpDisplay}, CLS=${r.mobile.clsDisplay}, TBT=${r.mobile.tbtDisplay}`).join('\\n');\nconst desktopSummary = results.map(r => `${r.url}: Performance=${r.desktop.performance}, LCP=${r.desktop.lcpDisplay}, CLS=${r.desktop.clsDisplay}, TBT=${r.desktop.tbtDisplay}`).join('\\n');\nconst comparisonSummary = results.map(r => `${r.url}: Mobile=${r.mobile.performance}, Desktop=${r.desktop.performance}, Diff=${(r.desktop.performance||0)-(r.mobile.performance||0)}`).join('\\n');\nconst recsSummary = Array.from(recsMap.entries()).sort((a,b) => b[1]-a[1]).map(([rec, count]) => `${rec}: ${count} URLs`).join('\\n');\n\nconst processingTime = Math.round((Date.now() - state.startTime) / 1000);\n\nreturn [{\n  json: {\n    spreadsheetId: state.spreadsheetId,\n    mobileRows: mobileRows,\n    desktopRows: desktopRows,\n    comparisonRows: comparisonRows,\n    recommendationsRows: recommendationsRows,\n    totalUrls: results.length,\n    processingTime: processingTime,\n    avgMobilePerf: avgMobilePerf,\n    avgDesktopPerf: avgDesktopPerf,\n    mobileSummary: mobileSummary,\n    desktopSummary: desktopSummary,\n    comparisonSummary: comparisonSummary,\n    recsSummary: recsSummary\n  }\n}];"
      },
      "id": "node-format-results",
      "name": "Format Results",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2940, 400]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://sheets.googleapis.com/v4/spreadsheets/{{ $json.spreadsheetId }}/values:batchUpdate",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "googleSheetsOAuth2Api",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"valueInputOption\": \"RAW\",\n  \"data\": [\n    {\"range\": \"'Mobile Results'!A1\", \"values\": {{ JSON.stringify($('Merge AI Comments').first().json.mobileRows) }}},\n    {\"range\": \"'Desktop Results'!A1\", \"values\": {{ JSON.stringify($('Merge AI Comments').first().json.desktopRows) }}},\n    {\"range\": \"'Comparison'!A1\", \"values\": {{ JSON.stringify($('Merge AI Comments').first().json.comparisonRows) }}},\n    {\"range\": \"'Recommendations'!A1\", \"values\": {{ JSON.stringify($('Merge AI Comments').first().json.recommendationsRows) }}}\n  ]\n}",
        "options": {}
      },
      "id": "node-write-results",
      "name": "Write Results",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [3180, 400],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "hMp9ISVYVcdpImYl",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://sheets.googleapis.com/v4/spreadsheets/{{ $('Merge AI Comments').first().json.spreadsheetId }}:batchUpdate",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "googleSheetsOAuth2Api",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"requests\": [\n    {\n      \"repeatCell\": {\n        \"range\": { \"sheetId\": 0, \"startRowIndex\": 0, \"endRowIndex\": 1 },\n        \"cell\": {\n          \"userEnteredFormat\": {\n            \"backgroundColor\": { \"red\": 0.063, \"green\": 0.725, \"blue\": 0.506 },\n            \"textFormat\": { \"bold\": true, \"foregroundColor\": { \"red\": 1, \"green\": 1, \"blue\": 1 }, \"fontSize\": 11 }\n          }\n        },\n        \"fields\": \"userEnteredFormat(backgroundColor,textFormat)\"\n      }\n    },\n    {\n      \"repeatCell\": {\n        \"range\": { \"sheetId\": 1, \"startRowIndex\": 0, \"endRowIndex\": 1 },\n        \"cell\": {\n          \"userEnteredFormat\": {\n            \"backgroundColor\": { \"red\": 0.063, \"green\": 0.725, \"blue\": 0.506 },\n            \"textFormat\": { \"bold\": true, \"foregroundColor\": { \"red\": 1, \"green\": 1, \"blue\": 1 }, \"fontSize\": 11 }\n          }\n        },\n        \"fields\": \"userEnteredFormat(backgroundColor,textFormat)\"\n      }\n    },\n    {\n      \"repeatCell\": {\n        \"range\": { \"sheetId\": 2, \"startRowIndex\": 0, \"endRowIndex\": 1 },\n        \"cell\": {\n          \"userEnteredFormat\": {\n            \"backgroundColor\": { \"red\": 0.231, \"green\": 0.349, \"blue\": 0.596 },\n            \"textFormat\": { \"bold\": true, \"foregroundColor\": { \"red\": 1, \"green\": 1, \"blue\": 1 }, \"fontSize\": 11 }\n          }\n        },\n        \"fields\": \"userEnteredFormat(backgroundColor,textFormat)\"\n      }\n    },\n    {\n      \"repeatCell\": {\n        \"range\": { \"sheetId\": 3, \"startRowIndex\": 0, \"endRowIndex\": 1 },\n        \"cell\": {\n          \"userEnteredFormat\": {\n            \"backgroundColor\": { \"red\": 0.961, \"green\": 0.620, \"blue\": 0.043 },\n            \"textFormat\": { \"bold\": true, \"foregroundColor\": { \"red\": 1, \"green\": 1, \"blue\": 1 }, \"fontSize\": 11 }\n          }\n        },\n        \"fields\": \"userEnteredFormat(backgroundColor,textFormat)\"\n      }\n    },\n    {\n      \"autoResizeDimensions\": {\n        \"dimensions\": { \"sheetId\": 0, \"dimension\": \"COLUMNS\", \"startIndex\": 0, \"endIndex\": 11 }\n      }\n    },\n    {\n      \"autoResizeDimensions\": {\n        \"dimensions\": { \"sheetId\": 1, \"dimension\": \"COLUMNS\", \"startIndex\": 0, \"endIndex\": 11 }\n      }\n    },\n    {\n      \"autoResizeDimensions\": {\n        \"dimensions\": { \"sheetId\": 2, \"dimension\": \"COLUMNS\", \"startIndex\": 0, \"endIndex\": 8 }\n      }\n    },\n    {\n      \"setBasicFilter\": {\n        \"filter\": { \"range\": { \"sheetId\": 0, \"startRowIndex\": 0 } }\n      }\n    },\n    {\n      \"setBasicFilter\": {\n        \"filter\": { \"range\": { \"sheetId\": 1, \"startRowIndex\": 0 } }\n      }\n    },\n    {\n      \"setBasicFilter\": {\n        \"filter\": { \"range\": { \"sheetId\": 2, \"startRowIndex\": 0 } }\n      }\n    }\n  ]\n}",
        "options": {}
      },
      "id": "node-format-sheet",
      "name": "Format Sheet",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [3420, 400],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "hMp9ISVYVcdpImYl",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\n  \"status\": \"success\",\n  \"spreadsheet_url\": \"https://docs.google.com/spreadsheets/d/{{ $('Merge AI Comments').first().json.spreadsheetId }}\",\n  \"total_urls\": {{ $('Merge AI Comments').first().json.totalUrls }},\n  \"processing_time_seconds\": {{ $('Merge AI Comments').first().json.processingTime }}\n}",
        "options": {}
      },
      "id": "node-respond",
      "name": "Respond",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.2,
      "position": [4140, 400]
    },
    {
      "parameters": {
        "model": "gpt-4o-mini",
        "messages": {
          "values": [
            {
              "content": "=–¢–∏ SEO-–µ–∫—Å–ø–µ—Ä—Ç. –ü—Ä–æ–∞–Ω–∞–ª—ñ–∑—É–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ PageSpeed —Ç–µ—Å—Ç—É —ñ –¥–∞–π –∫–æ—Ä–æ—Ç–∫–∏–π –≤–∏—Å–Ω–æ–≤–æ–∫ —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é –º–æ–≤–æ—é.\n\n## MOBILE RESULTS (—Å–µ—Ä–µ–¥–Ω—ñ–π –±–∞–ª: {{ $json.avgMobilePerf }})\n{{ $json.mobileSummary }}\n\n## DESKTOP RESULTS (—Å–µ—Ä–µ–¥–Ω—ñ–π –±–∞–ª: {{ $json.avgDesktopPerf }})\n{{ $json.desktopSummary }}\n\n## –ü–û–†–Ü–í–ù–Ø–ù–ù–Ø\n{{ $json.comparisonSummary }}\n\n## –†–ï–ö–û–ú–ï–ù–î–ê–¶–Ü–á\n{{ $json.recsSummary }}\n\n–ù–∞–ø–∏—à–∏ 4 –æ–∫—Ä–µ–º—ñ –≤–∏—Å–Ω–æ–≤–∫–∏ (–ø–æ 2-3 —Ä–µ—á–µ–Ω–Ω—è –∫–æ–∂–µ–Ω):\n1. MOBILE: [–∞–Ω–∞–ª—ñ–∑ –º–æ–±—ñ–ª—å–Ω–æ—ó –≤–µ—Ä—Å—ñ—ó]\n2. DESKTOP: [–∞–Ω–∞–ª—ñ–∑ –¥–µ—Å–∫—Ç–æ–ø–Ω–æ—ó –≤–µ—Ä—Å—ñ—ó]\n3. COMPARISON: [–ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è mobile vs desktop]\n4. RECOMMENDATIONS: [–ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç–Ω—ñ –¥—ñ—ó]\n\n–í—ñ–¥–ø–æ–≤—ñ–¥–∞–π –¢–Ü–õ–¨–ö–ò —É —Ñ–æ—Ä–º–∞—Ç—ñ JSON:\n{\"mobile\": \"...\", \"desktop\": \"...\", \"comparison\": \"...\", \"recommendations\": \"...\"}"
            }
          ]
        },
        "options": {
          "temperature": 0.3,
          "maxTokens": 1000
        }
      },
      "id": "node-ai-analysis",
      "name": "AI Analysis",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [3180, 600],
      "credentials": {
        "openAiApi": {
          "id": "openai-credentials",
          "name": "OpenAI"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Parse AI response and prepare for writing\nconst formatData = $('Format Results').first().json;\nconst aiResponse = $('AI Analysis').first().json;\n\n// Parse AI JSON response\nlet aiComments = { mobile: '', desktop: '', comparison: '', recommendations: '' };\ntry {\n  const content = aiResponse.message?.content || aiResponse.text || '';\n  const jsonMatch = content.match(/\\{[\\s\\S]*\\}/);\n  if (jsonMatch) {\n    aiComments = JSON.parse(jsonMatch[0]);\n  }\n} catch (e) {\n  aiComments = {\n    mobile: '–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –∞–Ω–∞–ª—ñ–∑',\n    desktop: '–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –∞–Ω–∞–ª—ñ–∑',\n    comparison: '–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –∞–Ω–∞–ª—ñ–∑',\n    recommendations: '–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –∞–Ω–∞–ª—ñ–∑'\n  };\n}\n\n// Add AI comments to each sheet (after data rows)\nconst mobileRows = [...formatData.mobileRows, [], ['üìä AI –ê–ù–ê–õ–Ü–ó:'], [aiComments.mobile]];\nconst desktopRows = [...formatData.desktopRows, [], ['üìä AI –ê–ù–ê–õ–Ü–ó:'], [aiComments.desktop]];\nconst comparisonRows = [...formatData.comparisonRows, [], ['üìä AI –ê–ù–ê–õ–Ü–ó:'], [aiComments.comparison]];\nconst recommendationsRows = [...formatData.recommendationsRows, [], ['üìä AI –ê–ù–ê–õ–Ü–ó:'], [aiComments.recommendations]];\n\nreturn [{\n  json: {\n    ...formatData,\n    mobileRows: mobileRows,\n    desktopRows: desktopRows,\n    comparisonRows: comparisonRows,\n    recommendationsRows: recommendationsRows\n  }\n}];"
      },
      "id": "node-merge-ai",
      "name": "Merge AI Comments",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [3420, 600]
    }
  ],
  "connections": {
    "Webhook": {
      "main": [[{ "node": "Set Variables", "type": "main", "index": 0 }]]
    },
    "Set Variables": {
      "main": [[{ "node": "Read Source URLs", "type": "main", "index": 0 }]]
    },
    "Read Source URLs": {
      "main": [[{ "node": "Parse URLs", "type": "main", "index": 0 }]]
    },
    "Parse URLs": {
      "main": [[{ "node": "Create Result Sheet", "type": "main", "index": 0 }]]
    },
    "Create Result Sheet": {
      "main": [[{ "node": "Merge Init Data", "type": "main", "index": 0 }]]
    },
    "Merge Init Data": {
      "main": [[{ "node": "Process Current Batch", "type": "main", "index": 0 }]]
    },
    "Process Current Batch": {
      "main": [[{ "node": "Split to Items", "type": "main", "index": 0 }]]
    },
    "Split to Items": {
      "main": [
        [
          { "node": "PageSpeed Mobile", "type": "main", "index": 0 },
          { "node": "PageSpeed Desktop", "type": "main", "index": 0 }
        ]
      ]
    },
    "PageSpeed Mobile": {
      "main": [[{ "node": "Merge Mobile Desktop", "type": "main", "index": 0 }]]
    },
    "PageSpeed Desktop": {
      "main": [[{ "node": "Merge Mobile Desktop", "type": "main", "index": 1 }]]
    },
    "Merge Mobile Desktop": {
      "main": [[{ "node": "Merge Batch Results", "type": "main", "index": 0 }]]
    },
    "Merge Batch Results": {
      "main": [[{ "node": "Has More Batches?", "type": "main", "index": 0 }]]
    },
    "Has More Batches?": {
      "main": [
        [{ "node": "Wait", "type": "main", "index": 0 }],
        [{ "node": "Format Results", "type": "main", "index": 0 }]
      ]
    },
    "Wait": {
      "main": [[{ "node": "Process Current Batch", "type": "main", "index": 0 }]]
    },
    "Format Results": {
      "main": [[{ "node": "AI Analysis", "type": "main", "index": 0 }]]
    },
    "AI Analysis": {
      "main": [[{ "node": "Merge AI Comments", "type": "main", "index": 0 }]]
    },
    "Merge AI Comments": {
      "main": [[{ "node": "Write Results", "type": "main", "index": 0 }]]
    },
    "Write Results": {
      "main": [[{ "node": "Format Sheet", "type": "main", "index": 0 }]]
    },
    "Format Sheet": {
      "main": [[{ "node": "Respond", "type": "main", "index": 0 }]]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 0,
  "active": false,
  "versionId": "1"
}
