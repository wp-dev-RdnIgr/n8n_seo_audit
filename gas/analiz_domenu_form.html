<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/dist/tabler-icons.min.css">
  <style>
    :root {
      --color-primary: #0F172A;
      --color-accent: #3B82F6;
      --color-accent-hover: #2563EB;
      --color-accent-light: #DBEAFE;
      --color-accent-lighter: #EFF6FF;
      --color-success: #10B981;
      --color-success-light: #D1FAE5;
      --color-error: #EF4444;
      --color-error-light: #FEE2E2;
      --color-warning: #F59E0B;
      --color-warning-light: #FEF3C7;
      --color-bg: #F1F5F9;
      --color-surface: #FFFFFF;
      --color-border: #E2E8F0;
      --color-border-hover: #CBD5E1;
      --color-text: #0F172A;
      --color-text-secondary: #475569;
      --color-text-muted: #94A3B8;
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
      --shadow-md: 0 4px 16px rgba(0,0,0,0.06);
      --transition: 0.2s ease;
      --sidebar-w: 260px;
      --header-h: 56px;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--color-bg);
      color: var(--color-text);
      min-height: 100vh;
      overflow: hidden;
      -webkit-font-smoothing: antialiased;
    }

    /* === HEADER === */
    .master-header {
      height: var(--header-h);
      background: var(--color-primary);
      display: flex;
      align-items: center;
      padding: 0 24px;
      gap: 12px;
      flex-shrink: 0;
    }
    .master-header-icon {
      width: 32px; height: 32px;
      background: rgba(59,130,246,0.15);
      border-radius: var(--radius-sm);
      display: flex; align-items: center; justify-content: center;
      color: var(--color-accent); font-size: 18px;
    }
    .master-header-title { font-size: 15px; font-weight: 600; color: #fff; }
    .master-header-sub { font-size: 12px; color: var(--color-text-muted); margin-left: auto; }

    /* === LAYOUT === */
    .master-wrap { display: flex; flex-direction: column; height: 100vh; }
    .master-layout {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* === SIDEBAR === */
    .master-sidebar {
      width: var(--sidebar-w);
      background: var(--color-surface);
      border-right: 1px solid var(--color-border);
      padding: 28px 20px;
      overflow-y: auto;
      flex-shrink: 0;
    }
    .sb-group-label {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--color-text-muted);
      margin: 20px 0 12px 44px;
    }
    .sb-group-label:first-child { margin-top: 0; }
    .sb-step {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 12px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: background var(--transition);
      position: relative;
      margin-bottom: 2px;
    }
    .sb-step:hover { background: #F8FAFC; }
    .sb-step.active { background: var(--color-accent-lighter); }
    .sb-circle {
      width: 30px; height: 30px;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 13px; font-weight: 600;
      flex-shrink: 0;
      transition: all var(--transition);
      background: #F1F5F9;
      color: var(--color-text-muted);
    }
    .sb-step.active .sb-circle {
      background: var(--color-accent);
      color: #fff;
      box-shadow: 0 0 0 3px rgba(59,130,246,0.15);
    }
    .sb-step.completed .sb-circle {
      background: var(--color-success);
      color: #fff;
    }
    .sb-step.skipped .sb-circle {
      background: transparent;
      border: 2px dashed #CBD5E1;
      color: #CBD5E1;
    }
    .sb-label { font-size: 13px; font-weight: 500; color: var(--color-text-secondary); }
    .sb-step.active .sb-label { color: var(--color-accent); font-weight: 600; }
    .sb-step.completed .sb-label { color: var(--color-success); }
    .sb-step.skipped .sb-label { color: #CBD5E1; }

    /* === MOBILE PROGRESS === */
    .mobile-progress {
      display: none;
      align-items: center;
      gap: 12px;
      background: var(--color-surface);
      border-bottom: 1px solid var(--color-border);
      padding: 12px 20px;
    }
    .mobile-progress-label { font-size: 13px; font-weight: 600; color: var(--color-text-secondary); white-space: nowrap; }
    .mobile-bar { flex: 1; height: 4px; background: #E2E8F0; border-radius: 4px; overflow: hidden; }
    .mobile-bar-fill { height: 100%; background: var(--color-accent); border-radius: 4px; transition: width 0.3s ease; }

    /* === CONTENT === */
    .master-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .step-scroll {
      flex: 1;
      overflow-y: auto;
      padding: 32px 40px;
    }
    .step-panel { display: none; max-width: 640px; }
    .step-panel.visible {
      display: block;
      animation: fadeIn 0.25s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* === STEP CARD === */
    .step-card {
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-lg);
      padding: 32px 28px;
      box-shadow: var(--shadow-sm);
    }
    .step-card-header {
      display: flex;
      align-items: center;
      gap: 14px;
      margin-bottom: 24px;
      padding-bottom: 18px;
      border-bottom: 1px solid #F1F5F9;
    }
    .step-card-icon {
      width: 44px; height: 44px;
      border-radius: var(--radius-md);
      display: flex; align-items: center; justify-content: center;
      font-size: 22px;
      background: var(--color-accent-lighter);
      color: var(--color-accent);
      flex-shrink: 0;
    }
    .step-card-title { font-size: 17px; font-weight: 700; }
    .step-card-desc { font-size: 13px; color: var(--color-text-secondary); margin-top: 2px; }

    /* === FORMS === */
    .form-group { margin-bottom: 20px; }
    .form-group:last-child { margin-bottom: 0; }
    .form-label {
      display: flex; align-items: center; gap: 6px;
      font-size: 13px; font-weight: 600; color: #334155;
      margin-bottom: 7px;
    }
    .form-label i { font-size: 15px; color: var(--color-text-muted); }
    .required-mark { color: var(--color-error); font-weight: 700; }
    .input-wrap { position: relative; }
    .input-wrap .input-ico {
      position: absolute; left: 13px; top: 50%; transform: translateY(-50%);
      font-size: 17px; color: #94A3B8; pointer-events: none;
    }
    .form-input {
      width: 100%;
      padding: 12px 14px 12px 42px;
      font-size: 14px; font-family: inherit;
      border: 1.5px solid var(--color-border);
      border-radius: var(--radius-sm);
      background: #FAFBFC;
      color: var(--color-text);
      transition: all var(--transition);
    }
    .form-input:focus {
      border-color: var(--color-accent); background: #fff;
      box-shadow: 0 0 0 3px rgba(59,130,246,0.1); outline: none;
    }
    .form-input::placeholder { color: #94A3B8; }
    .form-input.no-icon { padding-left: 14px; }
    .form-input.error { border-color: var(--color-error); }
    .form-select {
      width: 100%; padding: 12px 14px;
      font-size: 14px; font-family: inherit;
      border: 1.5px solid var(--color-border);
      border-radius: var(--radius-sm);
      background: #FAFBFC; color: var(--color-text);
      transition: all var(--transition);
      cursor: pointer;
      -webkit-appearance: none; appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2394A3B8' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 14px center;
    }
    .form-select:focus {
      border-color: var(--color-accent);
      box-shadow: 0 0 0 3px rgba(59,130,246,0.1); outline: none;
    }
    .form-hint {
      display: flex; align-items: center; gap: 5px;
      font-size: 12px; color: var(--color-text-muted); margin-top: 6px;
    }
    .form-hint i { font-size: 14px; }
    .form-error {
      font-size: 12px; color: var(--color-error);
      margin-top: 5px; display: none;
    }
    .form-error.visible { display: block; }
    .form-row { display: flex; gap: 14px; }
    .form-row .form-group { flex: 1; }

    /* === INFO BOX === */
    .info-box {
      display: flex; align-items: flex-start; gap: 10px;
      padding: 12px 14px;
      background: var(--color-accent-lighter);
      border-radius: var(--radius-sm);
      font-size: 13px; color: var(--color-text-secondary);
      line-height: 1.55; margin-bottom: 20px;
    }
    .info-box i { font-size: 17px; color: var(--color-accent); flex-shrink: 0; margin-top: 1px; }

    /* === TAGS === */
    .tags-wrap {
      border: 1.5px solid var(--color-border);
      border-radius: var(--radius-sm);
      padding: 8px 10px;
      display: flex; flex-wrap: wrap; gap: 6px;
      min-height: 46px;
      background: #FAFBFC; cursor: text;
      transition: all var(--transition);
    }
    .tags-wrap:focus-within {
      border-color: var(--color-accent); background: #fff;
      box-shadow: 0 0 0 3px rgba(59,130,246,0.1);
    }
    .tag {
      display: inline-flex; align-items: center; gap: 5px;
      padding: 5px 8px 5px 10px;
      background: var(--color-accent-light);
      color: var(--color-accent-hover);
      border-radius: 6px; font-size: 13px; font-weight: 500;
      animation: tagPop 0.15s ease;
    }
    @keyframes tagPop { from { opacity:0; transform:scale(0.85); } to { opacity:1; transform:scale(1); } }
    .tag-remove {
      display: flex; align-items: center; justify-content: center;
      width: 18px; height: 18px; border-radius: 4px;
      cursor: pointer; font-size: 14px;
      color: var(--color-accent); transition: all var(--transition);
    }
    .tag-remove:hover { background: rgba(59,130,246,0.15); }
    .tags-input {
      flex: 1; min-width: 140px; border: none; outline: none;
      font-size: 14px; font-family: inherit;
      background: transparent; color: var(--color-text);
      padding: 4px 2px;
    }
    .tags-input::placeholder { color: #94A3B8; }
    .tags-count { font-size: 12px; color: var(--color-text-muted); margin-top: 6px; }

    /* === OPTION CARDS === */
    .options-row { display: flex; gap: 12px; }
    .option-card {
      flex: 1; display: flex; align-items: center; gap: 12px;
      padding: 14px 16px;
      border: 1.5px solid var(--color-border);
      border-radius: var(--radius-sm);
      cursor: pointer; transition: all var(--transition);
      user-select: none;
    }
    .option-card:hover { border-color: var(--color-border-hover); }
    .option-card.selected {
      border-color: var(--color-accent);
      background: var(--color-accent-lighter);
    }
    .option-card-icon { font-size: 22px; color: var(--color-text-muted); }
    .option-card.selected .option-card-icon { color: var(--color-accent); }
    .option-card-label { font-size: 14px; font-weight: 500; }
    .option-card-check {
      margin-left: auto; font-size: 18px;
      color: var(--color-accent); opacity: 0;
      transition: opacity var(--transition);
    }
    .option-card.selected .option-card-check { opacity: 1; }

    /* === BUTTONS === */
    .btn-launch {
      width: 100%; padding: 16px;
      font-size: 15px; font-weight: 600; font-family: inherit;
      color: #fff;
      background: linear-gradient(135deg, var(--color-accent), var(--color-accent-hover));
      border: none; border-radius: var(--radius-md);
      cursor: pointer;
      display: flex; align-items: center; justify-content: center; gap: 8px;
      transition: all var(--transition);
      margin-top: 20px; position: relative; overflow: hidden;
    }
    .btn-launch:hover:not(:disabled) {
      box-shadow: 0 6px 20px rgba(59,130,246,0.35);
      transform: translateY(-1px);
    }
    .btn-launch:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; }
    .btn-launch i { font-size: 20px; }
    .btn-loading > * { visibility: hidden; }
    .btn-loading::after {
      content: ''; position: absolute;
      top: 50%; left: 50%;
      width: 20px; height: 20px; margin: -10px 0 0 -10px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: #fff; border-radius: 50%;
      animation: spin 0.7s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* === STEP NAV === */
    .step-nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 40px;
      border-top: 1px solid var(--color-border);
      background: var(--color-surface);
      flex-shrink: 0;
    }
    .step-nav-right { display: flex; align-items: center; gap: 10px; }
    .nav-btn {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 10px 20px;
      font-size: 14px; font-weight: 500; font-family: inherit;
      border: none; border-radius: var(--radius-sm);
      cursor: pointer; transition: all var(--transition);
    }
    .nav-btn:disabled { opacity: 0.35; cursor: not-allowed; }
    .nav-btn i { font-size: 17px; }
    .nav-btn-back { background: transparent; color: var(--color-text-secondary); }
    .nav-btn-back:hover:not(:disabled) { background: #F1F5F9; }
    .nav-btn-skip { background: transparent; color: var(--color-text-muted); }
    .nav-btn-skip:hover:not(:disabled) { color: var(--color-text-secondary); }
    .nav-btn-next {
      background: var(--color-accent); color: #fff;
      padding: 10px 24px;
    }
    .nav-btn-next:hover:not(:disabled) {
      background: var(--color-accent-hover);
      box-shadow: 0 2px 8px rgba(59,130,246,0.3);
    }

    /* === SUMMARY (Step 4) === */
    .summary-list { display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px; }
    .summary-item {
      display: flex; align-items: center; gap: 10px;
      padding: 12px 14px;
      border-radius: var(--radius-sm);
      font-size: 13px; font-weight: 500;
    }
    .summary-item i:first-child { font-size: 18px; }
    .summary-item.active {
      background: var(--color-accent-lighter);
      color: var(--color-accent-hover);
    }
    .summary-item.skipped {
      background: #F8FAFC;
      color: var(--color-text-muted);
    }

    /* === RESULTS === */
    .result-card {
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      padding: 16px; margin-top: 16px;
      animation: fadeIn 0.3s ease;
    }
    .result-card.success { border-color: #BBF7D0; background: #F0FDF4; }
    .result-card.error { border-color: #FECACA; background: #FEF2F2; }
    .result-card.loading { border-color: var(--color-accent-light); background: var(--color-accent-lighter); }
    .result-card.hidden { display: none; }
    .result-card-header {
      display: flex; align-items: center; gap: 8px;
      font-size: 14px; font-weight: 600;
    }
    .result-card.success .result-card-header { color: #166534; }
    .result-card.error .result-card-header { color: #991B1B; }
    .result-card.loading .result-card-header { color: var(--color-accent-hover); }
    .result-card-header i { font-size: 18px; }
    .result-link {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 10px 16px;
      font-size: 13px; font-weight: 500;
      color: var(--color-accent-hover);
      background: var(--color-accent-lighter);
      border: 1px solid var(--color-accent-light);
      border-radius: var(--radius-sm);
      text-decoration: none; transition: all var(--transition);
      margin-top: 8px;
    }
    .result-link:hover { background: var(--color-accent-light); }
    .result-link i { font-size: 16px; }
    .result-link.doc-link { color: #7C3AED; background: #EDE9FE; border-color: #DDD6FE; }
    .result-link.doc-link:hover { background: #DDD6FE; }
    .result-link.folder-link { color: #166534; background: #F0FDF4; border-color: #BBF7D0; }
    .result-link.folder-link:hover { background: #DCFCE7; }
    .result-link-row { display: flex; align-items: center; gap: 8px; margin-top: 8px; }
    .result-link-row .result-link { flex: 1; margin-top: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .copy-btn {
      width: 38px; height: 38px;
      display: flex; align-items: center; justify-content: center;
      background: var(--color-accent-lighter);
      border: 1px solid var(--color-accent-light);
      border-radius: var(--radius-sm);
      cursor: pointer; font-size: 16px;
      color: var(--color-accent);
      transition: all var(--transition); flex-shrink: 0;
    }
    .copy-btn:hover { background: var(--color-accent-light); }
    .copy-btn.copied { background: var(--color-success-light); border-color: #BBF7D0; color: var(--color-success); }
    .competitor-result-item {
      display: flex; align-items: center; gap: 8px;
      padding: 6px 0; font-size: 13px; color: var(--color-text-secondary);
    }
    .competitor-result-item a { color: var(--color-accent-hover); text-decoration: none; font-weight: 500; }
    .competitor-result-item a:hover { text-decoration: underline; }
    .competitor-result-item .copy-btn { width: 26px; height: 26px; font-size: 13px; }
    .detail-dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
    .detail-dot.success { background: var(--color-success); }
    .detail-dot.error { background: var(--color-error); }

    /* === RESPONSIVE === */
    @media (max-width: 767px) {
      .master-sidebar { display: none; }
      .mobile-progress { display: flex; }
      .step-scroll { padding: 20px 16px; }
      .step-nav { padding: 12px 16px; }
      .step-card { padding: 24px 20px; }
    }
    @media (max-width: 520px) {
      .form-row { flex-direction: column; gap: 0; }
      .options-row { flex-direction: column; }
    }
  </style>
</head>
<body>
<div class="master-wrap">

  <!-- HEADER -->
  <header class="master-header">
    <div class="master-header-icon"><i class="ti ti-chart-dots-3"></i></div>
    <div class="master-header-title">SEO Audit — Мастер-оркестратор</div>
    <div class="master-header-sub">WebPromo</div>
  </header>

  <div class="master-layout">

    <!-- SIDEBAR -->
    <aside class="master-sidebar" id="sidebar">
      <div class="sb-group-label">Етап 1 — Збір даних</div>
      <div class="sb-step active" data-step="1" onclick="goToStep(1)">
        <div class="sb-circle">1</div>
        <div class="sb-label">Основні дані</div>
      </div>
      <div class="sb-step" data-step="2" onclick="goToStep(2)">
        <div class="sb-circle">2</div>
        <div class="sb-label">Конкуренти</div>
      </div>
      <div class="sb-step" data-step="3" onclick="goToStep(3)">
        <div class="sb-circle">3</div>
        <div class="sb-label">Семантика</div>
      </div>
      <div class="sb-step" data-step="4" onclick="goToStep(4)">
        <div class="sb-circle">4</div>
        <div class="sb-label">Запуск аналізу</div>
      </div>
      <div class="sb-group-label">Етап 2 — Обробка</div>
      <div class="sb-step" data-step="5" onclick="goToStep(5)">
        <div class="sb-circle">5</div>
        <div class="sb-label">Метрики</div>
      </div>
      <div class="sb-step" data-step="6" onclick="goToStep(6)">
        <div class="sb-circle">6</div>
        <div class="sb-label">PageSpeed</div>
      </div>
      <div class="sb-step" data-step="7" onclick="goToStep(7)">
        <div class="sb-circle">7</div>
        <div class="sb-label">AI аналіз</div>
      </div>
      <div class="sb-step" data-step="8" onclick="goToStep(8)">
        <div class="sb-circle">8</div>
        <div class="sb-label">PDF парсинг</div>
      </div>
    </aside>

    <!-- MOBILE PROGRESS -->
    <div class="mobile-progress" id="mobileProgress">
      <div class="mobile-progress-label" id="mobileLabel">Крок 1 з 8</div>
      <div class="mobile-bar"><div class="mobile-bar-fill" id="mobileBar" style="width:12.5%"></div></div>
    </div>

    <!-- CONTENT -->
    <main class="master-content">
      <div class="step-scroll">

        <!-- STEP 1: Основні дані -->
        <section class="step-panel visible" data-step="1">
          <div class="step-card">
            <div class="step-card-header">
              <div class="step-card-icon"><i class="ti ti-user"></i></div>
              <div>
                <div class="step-card-title">Основні дані</div>
                <div class="step-card-desc">Email менеджера та домен клієнта</div>
              </div>
            </div>
            <div class="info-box">
              <i class="ti ti-info-circle"></i>
              <span>Введіть email менеджера — результати аналізу будуть збережені у його папку на Google Drive. Вкажіть домен клієнта у будь-якому форматі — ми автоматично приведемо його до потрібного вигляду.</span>
            </div>
            <div class="form-group">
              <label class="form-label"><i class="ti ti-mail"></i> Email менеджера <span class="required-mark">*</span></label>
              <div class="input-wrap">
                <i class="ti ti-mail input-ico"></i>
                <input type="email" id="fEmail" class="form-input" placeholder="manager@webpromo.com.ua" autocomplete="off">
              </div>
              <div class="form-error" id="fEmailErr">Введіть коректний email</div>
            </div>
            <div class="form-group">
              <label class="form-label"><i class="ti ti-world"></i> Домен клієнта <span class="required-mark">*</span></label>
              <div class="input-wrap">
                <i class="ti ti-link input-ico"></i>
                <input type="text" id="fDomain" class="form-input" placeholder="https://www.example.com.ua або example.com.ua" autocomplete="off" spellcheck="false">
              </div>
              <div class="form-hint"><i class="ti ti-info-circle"></i> Можна вводити з https://, www. або без — ми приберемо зайве автоматично</div>
              <div class="form-error" id="fDomainErr">Введіть домен клієнта</div>
            </div>
          </div>
        </section>

        <!-- STEP 2: Конкуренти -->
        <section class="step-panel" data-step="2">
          <div class="step-card">
            <div class="step-card-header">
              <div class="step-card-icon"><i class="ti ti-users"></i></div>
              <div>
                <div class="step-card-title">Аналіз конкурентів</div>
                <div class="step-card-desc">Додайте домени конкурентів для порівняльного аналізу</div>
              </div>
            </div>
            <div class="info-box">
              <i class="ti ti-info-circle"></i>
              <span>Для кожного конкурента буде створена окрема таблиця з аналізом органічного трафіку, ключових фраз та посилального профілю. Конкуренти обробляються послідовно.</span>
            </div>
            <div class="form-group">
              <label class="form-label"><i class="ti ti-world"></i> Домени конкурентів</label>
              <div class="tags-wrap" id="compTagsWrap" onclick="document.getElementById('compInput').focus()">
                <input type="text" class="tags-input" id="compInput" placeholder="Введіть домен та натисніть Enter" spellcheck="false">
              </div>
              <div class="form-hint"><i class="ti ti-info-circle"></i> Enter — додати, Backspace — видалити. Можна вставити список (Ctrl+V). Формат будь-який — https://, www. приберемо автоматично.</div>
              <div class="tags-count" id="compCount"></div>
            </div>
          </div>
        </section>

        <!-- STEP 3: Семантика -->
        <section class="step-panel" data-step="3">
          <div class="step-card">
            <div class="step-card-header">
              <div class="step-card-icon"><i class="ti ti-plant-2"></i></div>
              <div>
                <div class="step-card-title">Розширення семантичного ядра</div>
                <div class="step-card-desc">Генерація ідей ключових слів з seed-фраз</div>
              </div>
            </div>
            <div class="info-box">
              <i class="ti ti-bulb"></i>
              <span>Google Keyword Planner згенерує нові ідеї на основі seed-фраз з таблиці. Seed-фрази мають бути у першому стовпці першого аркуша.</span>
            </div>
            <div class="form-group">
              <label class="form-label"><i class="ti ti-table"></i> Таблиця з seed-фразами</label>
              <div class="input-wrap">
                <i class="ti ti-link input-ico"></i>
                <input type="text" id="fSemUrl" class="form-input" placeholder="https://docs.google.com/spreadsheets/d/..." autocomplete="off" spellcheck="false">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Мова</label>
                <select id="fSemLang" class="form-select">
                  <option value="1036" selected>Українська</option>
                  <option value="1000">English</option>
                  <option value="1030">Polski</option>
                  <option value="1031">Русский</option>
                  <option value="1001">Deutsch</option>
                  <option value="1002">Français</option>
                  <option value="1003">Español</option>
                  <option value="1004">Italiano</option>
                  <option value="1014">Português</option>
                  <option value="1010">Nederlands</option>
                  <option value="1021">Čeština</option>
                  <option value="1032">Română</option>
                  <option value="1024">Magyar</option>
                  <option value="1015">Svenska</option>
                  <option value="1037">Türkçe</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Регіон</label>
                <select id="fSemGeo" class="form-select">
                  <option value="2804" selected>Україна</option>
                  <option value="2840">США</option>
                  <option value="2826">Великобританія</option>
                  <option value="2616">Польща</option>
                  <option value="2276">Німеччина</option>
                  <option value="2250">Франція</option>
                  <option value="2724">Іспанія</option>
                  <option value="2380">Італія</option>
                  <option value="2528">Нідерланди</option>
                  <option value="2124">Канада</option>
                  <option value="2036">Австралія</option>
                  <option value="2203">Чехія</option>
                  <option value="2642">Румунія</option>
                  <option value="2040">Австрія</option>
                  <option value="2756">Швейцарія</option>
                  <option value="2792">Туреччина</option>
                </select>
              </div>
            </div>
          </div>
        </section>

        <!-- STEP 4: Запуск аналізу -->
        <section class="step-panel" data-step="4">
          <div class="step-card">
            <div class="step-card-header">
              <div class="step-card-icon" style="background:linear-gradient(135deg,var(--color-accent-light),#C7D2FE);color:var(--color-accent-hover);">
                <i class="ti ti-rocket"></i>
              </div>
              <div>
                <div class="step-card-title">Запуск збору даних</div>
                <div class="step-card-desc">Перевірте дані та запустіть аналіз</div>
              </div>
            </div>
            <div class="info-box">
              <i class="ti ti-info-circle"></i>
              <span>Перевірте обрані параметри та натисніть «Запустити». Час виконання залежить від кількості конкурентів (1-2 хв на домен).</span>
            </div>
            <div class="summary-list" id="summaryList"></div>
            <button class="btn-launch" id="btnLaunch1" onclick="launchPhase1()">
              <i class="ti ti-rocket"></i> <span>Запустити аналіз</span>
            </button>
            <div class="result-card hidden" id="phase1Result"></div>
            <div class="result-card hidden" id="clientResult"></div>
            <div class="result-card hidden" id="competitorsResult"></div>
            <div class="result-card hidden" id="semanticResult"></div>
          </div>
        </section>

        <!-- STEP 5: Метрики -->
        <section class="step-panel" data-step="5">
          <div class="step-card">
            <div class="step-card-header">
              <div class="step-card-icon"><i class="ti ti-chart-bar"></i></div>
              <div>
                <div class="step-card-title">Отримання метрик</div>
                <div class="step-card-desc">Об'єм пошуку, конкуренція, CPC для ключових слів</div>
              </div>
            </div>
            <div class="info-box">
              <i class="ti ti-bulb"></i>
              <span>Вкажіть таблицю з ключовими словами — Google Keyword Planner отримає об'єм пошуку та CPC. Можна використати результат з етапу «Семантика».</span>
            </div>
            <div class="form-group">
              <label class="form-label"><i class="ti ti-table"></i> Таблиця з ключовими словами</label>
              <div class="input-wrap">
                <i class="ti ti-link input-ico"></i>
                <input type="text" id="fMetUrl" class="form-input" placeholder="https://docs.google.com/spreadsheets/d/..." autocomplete="off" spellcheck="false">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Мова</label>
                <select id="fMetLang" class="form-select">
                  <option value="1036" selected>Українська</option>
                  <option value="1000">English</option>
                  <option value="1030">Polski</option>
                  <option value="1031">Русский</option>
                  <option value="1001">Deutsch</option>
                  <option value="1002">Français</option>
                  <option value="1003">Español</option>
                  <option value="1004">Italiano</option>
                  <option value="1014">Português</option>
                  <option value="1010">Nederlands</option>
                  <option value="1021">Čeština</option>
                  <option value="1032">Română</option>
                  <option value="1024">Magyar</option>
                  <option value="1015">Svenska</option>
                  <option value="1037">Türkçe</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Регіон</label>
                <select id="fMetGeo" class="form-select">
                  <option value="2804" selected>Україна</option>
                  <option value="2840">США</option>
                  <option value="2826">Великобританія</option>
                  <option value="2616">Польща</option>
                  <option value="2276">Німеччина</option>
                  <option value="2250">Франція</option>
                  <option value="2724">Іспанія</option>
                  <option value="2380">Італія</option>
                  <option value="2528">Нідерланди</option>
                  <option value="2124">Канада</option>
                  <option value="2036">Австралія</option>
                  <option value="2203">Чехія</option>
                  <option value="2642">Румунія</option>
                  <option value="2040">Австрія</option>
                  <option value="2756">Швейцарія</option>
                  <option value="2792">Туреччина</option>
                </select>
              </div>
            </div>
            <button class="btn-launch" id="btnMetrics" onclick="launchMetrics()">
              <i class="ti ti-chart-bar"></i> <span>Отримати метрики</span>
            </button>
            <div class="result-card hidden" id="metricsResult"></div>
          </div>
        </section>

        <!-- STEP 6: PageSpeed -->
        <section class="step-panel" data-step="6">
          <div class="step-card">
            <div class="step-card-header">
              <div class="step-card-icon"><i class="ti ti-gauge"></i></div>
              <div>
                <div class="step-card-title">PageSpeed Test</div>
                <div class="step-card-desc">Аналіз швидкості завантаження сторінок</div>
              </div>
            </div>
            <div class="info-box">
              <i class="ti ti-bulb"></i>
              <span>Вкажіть таблицю з URL-адресами сторінок — Google PageSpeed Insights протестує швидкість та Core Web Vitals (LCP, FID, CLS).</span>
            </div>
            <div class="form-group">
              <label class="form-label"><i class="ti ti-table"></i> Таблиця з URL для тестування</label>
              <div class="input-wrap">
                <i class="ti ti-link input-ico"></i>
                <input type="text" id="fPsUrl" class="form-input" placeholder="https://docs.google.com/spreadsheets/d/..." autocomplete="off" spellcheck="false">
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Тип тесту</label>
              <div class="options-row">
                <div class="option-card selected" id="optMobile" onclick="toggleOption('optMobile')">
                  <i class="ti ti-device-mobile option-card-icon"></i>
                  <span class="option-card-label">Mobile</span>
                  <i class="ti ti-check option-card-check"></i>
                </div>
                <div class="option-card selected" id="optDesktop" onclick="toggleOption('optDesktop')">
                  <i class="ti ti-device-desktop option-card-icon"></i>
                  <span class="option-card-label">Desktop</span>
                  <i class="ti ti-check option-card-check"></i>
                </div>
              </div>
            </div>
            <button class="btn-launch" id="btnPageSpeed" onclick="launchPageSpeed()">
              <i class="ti ti-gauge"></i> <span>Запустити PageSpeed</span>
            </button>
            <div class="result-card hidden" id="pagespeedResult"></div>
          </div>
        </section>

        <!-- STEP 7: AI аналіз -->
        <section class="step-panel" data-step="7">
          <div class="step-card">
            <div class="step-card-header">
              <div class="step-card-icon"><i class="ti ti-brain"></i></div>
              <div>
                <div class="step-card-title">AI аналіз домену</div>
                <div class="step-card-desc">AI-звіт з рекомендаціями на основі таблиці аналізу</div>
              </div>
            </div>
            <div class="info-box">
              <i class="ti ti-bulb"></i>
              <span>Вкажіть таблицю аналізу домену — AI згенерує звіт (Google Doc) з SEO-рекомендаціями. Використовуйте результат «Аналіз клієнта» з Етапу 1.</span>
            </div>
            <div class="form-group">
              <label class="form-label"><i class="ti ti-table"></i> Таблиця з аналізом домену</label>
              <div class="input-wrap">
                <i class="ti ti-link input-ico"></i>
                <input type="text" id="fAiUrl" class="form-input" placeholder="https://docs.google.com/spreadsheets/d/..." autocomplete="off" spellcheck="false">
              </div>
            </div>
            <button class="btn-launch" id="btnAI" onclick="launchAI()">
              <i class="ti ti-brain"></i> <span>Запустити AI аналіз</span>
            </button>
            <div class="result-card hidden" id="aiResult"></div>
          </div>
        </section>

        <!-- STEP 8: PDF парсинг -->
        <section class="step-panel" data-step="8">
          <div class="step-card">
            <div class="step-card-header">
              <div class="step-card-icon"><i class="ti ti-file-type-pdf"></i></div>
              <div>
                <div class="step-card-title">Парсинг PDF-аудиту</div>
                <div class="step-card-desc">Перетворення PDF у структуровану Google таблицю</div>
              </div>
            </div>
            <div class="info-box">
              <i class="ti ti-bulb"></i>
              <span>Вкажіть посилання на PDF-аудит з Google Drive — буде створена структурована таблиця з окремими вкладками для кожного розділу.</span>
            </div>
            <div class="form-group">
              <label class="form-label"><i class="ti ti-file-type-pdf"></i> Посилання на PDF (Google Drive)</label>
              <div class="input-wrap">
                <i class="ti ti-link input-ico"></i>
                <input type="text" id="fPdfUrl" class="form-input" placeholder="https://drive.google.com/file/d/..." autocomplete="off" spellcheck="false">
              </div>
            </div>
            <button class="btn-launch" id="btnPDF" onclick="launchPDF()">
              <i class="ti ti-file-type-pdf"></i> <span>Запустити парсинг PDF</span>
            </button>
            <div class="result-card hidden" id="pdfResult"></div>
          </div>
        </section>

      </div>

      <!-- NAVIGATION -->
      <div class="step-nav" id="stepNav">
        <button class="nav-btn nav-btn-back" id="navBack" onclick="prevStep()">
          <i class="ti ti-arrow-left"></i> Назад
        </button>
        <div class="step-nav-right">
          <button class="nav-btn nav-btn-skip" id="navSkip" onclick="skipStep()">
            Пропустити крок
          </button>
          <button class="nav-btn nav-btn-next" id="navNext" onclick="nextStep()">
            Далі <i class="ti ti-arrow-right"></i>
          </button>
        </div>
      </div>
    </main>
  </div>
</div>

<script>
// =========================================
// STATE
// =========================================
var currentStep = 1;
var totalSteps = 8;
var stepStatus = ['active','upcoming','upcoming','upcoming','upcoming','upcoming','upcoming','upcoming'];
var phase1Done = false;
var stepData = { email:'', domain:'', competitors:[], semantic:null, phase1Results:null };

// =========================================
// NAVIGATION
// =========================================
function goToStep(n) {
  if (n < 1 || n > totalSteps) return;
  // Can go back to completed/skipped, or forward to current+1
  if (n > currentStep + 1 && stepStatus[n-1] === 'upcoming') return;
  // For step 5+, must complete step 4 first
  if (n >= 5 && !phase1Done) return;

  // Save current step data
  saveStepData(currentStep);

  // Update previous step status
  if (stepStatus[currentStep - 1] === 'active') {
    stepStatus[currentStep - 1] = 'completed';
  }

  currentStep = n;
  stepStatus[n - 1] = 'active';

  showStep(n);
  updateSidebar();
  updateNav();

  // Pre-fill step 4 summary
  if (n === 4) buildSummary();
  // Pre-fill from Phase 1 results
  if (n === 5 && stepData.phase1Results && stepData.phase1Results.semantic) {
    var el = document.getElementById('fMetUrl');
    if (!el.value) el.value = stepData.phase1Results.semantic;
  }
  if (n === 7 && stepData.phase1Results && stepData.phase1Results.client) {
    var el = document.getElementById('fAiUrl');
    if (!el.value) el.value = stepData.phase1Results.client;
  }
}

function nextStep() {
  if (currentStep === totalSteps) return;
  if (!validateStep(currentStep)) return;
  saveStepData(currentStep);
  stepStatus[currentStep - 1] = 'completed';
  currentStep++;
  stepStatus[currentStep - 1] = 'active';
  showStep(currentStep);
  updateSidebar();
  updateNav();
  if (currentStep === 4) buildSummary();
  if (currentStep === 5 && stepData.phase1Results && stepData.phase1Results.semantic) {
    var el = document.getElementById('fMetUrl');
    if (!el.value) el.value = stepData.phase1Results.semantic;
  }
  if (currentStep === 7 && stepData.phase1Results && stepData.phase1Results.client) {
    var el = document.getElementById('fAiUrl');
    if (!el.value) el.value = stepData.phase1Results.client;
  }
}

function prevStep() {
  if (currentStep <= 1) return;
  saveStepData(currentStep);
  if (stepStatus[currentStep - 1] === 'active') {
    stepStatus[currentStep - 1] = 'upcoming';
  }
  currentStep--;
  stepStatus[currentStep - 1] = 'active';
  showStep(currentStep);
  updateSidebar();
  updateNav();
}

function skipStep() {
  if (currentStep === 1 || currentStep === 4) return;
  stepStatus[currentStep - 1] = 'skipped';
  currentStep++;
  if (currentStep > totalSteps) { currentStep = totalSteps; return; }
  stepStatus[currentStep - 1] = 'active';
  showStep(currentStep);
  updateSidebar();
  updateNav();
  if (currentStep === 4) buildSummary();
}

function normalizeDomain(val) {
  return val.trim()
    .replace(/^https?:\/\//i, '')
    .replace(/^www\./i, '')
    .replace(/\/+$/, '')
    .toLowerCase();
}

// Auto-normalize domain field on blur
document.getElementById('fDomain').addEventListener('blur', function() {
  var raw = this.value.trim();
  if (raw) {
    this.value = normalizeDomain(raw);
    document.getElementById('fDomainErr').classList.remove('visible');
    this.classList.remove('error');
  }
});

function saveStepData(n) {
  if (n === 1) {
    stepData.email = document.getElementById('fEmail').value.trim();
    stepData.domain = normalizeDomain(document.getElementById('fDomain').value);
  }
  if (n === 3) {
    var url = document.getElementById('fSemUrl').value.trim();
    if (url && url.includes('docs.google.com/spreadsheets')) {
      stepData.semantic = {
        url: url,
        lang: document.getElementById('fSemLang').value,
        geo: document.getElementById('fSemGeo').value
      };
    } else {
      stepData.semantic = null;
    }
  }
}

function validateStep(n) {
  if (n === 1) {
    var email = document.getElementById('fEmail').value.trim();
    var domain = document.getElementById('fDomain').value.trim();
    var ok = true;
    if (!email || !email.includes('@')) {
      document.getElementById('fEmailErr').classList.add('visible');
      document.getElementById('fEmail').classList.add('error');
      ok = false;
    } else {
      document.getElementById('fEmailErr').classList.remove('visible');
      document.getElementById('fEmail').classList.remove('error');
    }
    if (!domain) {
      document.getElementById('fDomainErr').classList.add('visible');
      document.getElementById('fDomain').classList.add('error');
      ok = false;
    } else {
      document.getElementById('fDomainErr').classList.remove('visible');
      document.getElementById('fDomain').classList.remove('error');
    }
    return ok;
  }
  if (n === 4) {
    return phase1Done;
  }
  return true;
}

// =========================================
// UI UPDATES
// =========================================
function showStep(n) {
  var panels = document.querySelectorAll('.step-panel');
  for (var i = 0; i < panels.length; i++) {
    panels[i].classList.remove('visible');
  }
  var target = document.querySelector('.step-panel[data-step="'+n+'"]');
  if (target) target.classList.add('visible');
  // Scroll to top
  document.querySelector('.step-scroll').scrollTop = 0;
}

function updateSidebar() {
  var steps = document.querySelectorAll('.sb-step');
  for (var i = 0; i < steps.length; i++) {
    var s = steps[i];
    var idx = parseInt(s.dataset.step) - 1;
    s.className = 'sb-step ' + stepStatus[idx];
    var circle = s.querySelector('.sb-circle');
    if (stepStatus[idx] === 'completed') {
      circle.innerHTML = '<i class="ti ti-check" style="font-size:15px"></i>';
    } else if (stepStatus[idx] === 'skipped') {
      circle.innerHTML = '<i class="ti ti-minus" style="font-size:13px"></i>';
    } else {
      circle.textContent = idx + 1;
    }
  }
  // Mobile
  document.getElementById('mobileLabel').textContent = 'Крок ' + currentStep + ' з ' + totalSteps;
  document.getElementById('mobileBar').style.width = (currentStep / totalSteps * 100) + '%';
}

function updateNav() {
  var back = document.getElementById('navBack');
  var skip = document.getElementById('navSkip');
  var next = document.getElementById('navNext');

  // Back
  back.style.visibility = currentStep > 1 ? 'visible' : 'hidden';

  // Skip — show for optional steps (2,3,5,6,7,8), hide for 1 and 4
  skip.style.display = (currentStep === 1 || currentStep === 4) ? 'none' : '';

  // Next
  if (currentStep === 4) {
    next.innerHTML = phase1Done
      ? 'Далі <i class="ti ti-arrow-right"></i>'
      : 'Очікується запуск';
    next.disabled = !phase1Done;
  } else if (currentStep === totalSteps) {
    next.style.display = 'none';
  } else {
    next.style.display = '';
    next.disabled = false;
    next.innerHTML = 'Далі <i class="ti ti-arrow-right"></i>';
  }
}

// =========================================
// STEP 4: SUMMARY + LAUNCH
// =========================================
function buildSummary() {
  saveStepData(3); // ensure semantic saved
  var el = document.getElementById('summaryList');
  var html = '';

  // Client
  html += '<div class="summary-item active"><i class="ti ti-world"></i> Аналіз клієнта: <strong>' + (stepData.domain || '—') + '</strong></div>';

  // Competitors
  if (stepData.competitors.length > 0) {
    html += '<div class="summary-item active"><i class="ti ti-users"></i> Конкуренти: <strong>' + stepData.competitors.length + ' доменів</strong></div>';
  } else if (stepStatus[1] === 'skipped') {
    html += '<div class="summary-item skipped"><i class="ti ti-minus"></i> Конкуренти: пропущено</div>';
  } else {
    html += '<div class="summary-item skipped"><i class="ti ti-minus"></i> Конкуренти: не додано</div>';
  }

  // Semantic
  if (stepData.semantic) {
    html += '<div class="summary-item active"><i class="ti ti-plant-2"></i> Семантика: <strong>таблиця додана</strong></div>';
  } else if (stepStatus[2] === 'skipped') {
    html += '<div class="summary-item skipped"><i class="ti ti-minus"></i> Семантика: пропущено</div>';
  } else {
    html += '<div class="summary-item skipped"><i class="ti ti-minus"></i> Семантика: не заповнено</div>';
  }

  el.innerHTML = html;

  // Reset launch button if not done
  if (!phase1Done) {
    var btn = document.getElementById('btnLaunch1');
    btn.disabled = false;
    btn.classList.remove('btn-loading');
  }
}

function launchPhase1() {
  if (phase1Done) return;
  var formData = { manager_email: stepData.email, client_domain: stepData.domain };

  if (stepData.competitors.length > 0) {
    formData.competitors = stepData.competitors.slice();
  }
  if (stepData.semantic) {
    formData.semantic_expansion = {
      report_name: 'Розширення семантичного ядра',
      spreadsheet_url: stepData.semantic.url,
      language: stepData.semantic.lang,
      geo_target: stepData.semantic.geo
    };
  }

  var btn = document.getElementById('btnLaunch1');
  btn.disabled = true;
  btn.classList.add('btn-loading');
  hideResults(['phase1Result','clientResult','competitorsResult','semanticResult']);

  google.script.run
    .withSuccessHandler(function(r) {
      btn.disabled = true;
      btn.classList.remove('btn-loading');
      if (r.success) {
        phase1Done = true;
        btn.innerHTML = '<i class="ti ti-circle-check"></i> <span>Аналіз завершено</span>';
        btn.style.background = 'var(--color-success)';
        onPhase1Success(r);
        updateNav();
      } else {
        btn.disabled = false;
        btn.classList.remove('btn-loading');
        showResultError('phase1Result', r.error || 'Невідома помилка');
      }
    })
    .withFailureHandler(function(e) {
      btn.disabled = false;
      btn.classList.remove('btn-loading');
      showResultError('phase1Result', e.toString());
    })
    .submitAnalizDomenu(formData);
}

function onPhase1Success(data) {
  var d = data.details || {};
  stepData.phase1Results = {};

  // Overall
  var r = document.getElementById('phase1Result');
  r.classList.remove('hidden');
  r.className = 'result-card success';
  var html = '<div class="result-card-header"><i class="ti ti-circle-check"></i> Збір даних завершено</div>';
  if (data.folderUrl) {
    html += '<a href="'+data.folderUrl+'" target="_blank" class="result-link folder-link"><i class="ti ti-folder"></i> Відкрити папку проекту</a>';
  }
  r.innerHTML = html;

  // Client
  if (d.client_analysis) {
    showResultSuccess('clientResult', 'Аналіз клієнта', d.client_analysis.spreadsheet_url);
    if (d.client_analysis.spreadsheet_url) stepData.phase1Results.client = d.client_analysis.spreadsheet_url;
  }

  // Competitors
  if (d.competitors_analysis && d.competitors_analysis.length > 0) {
    showCompetitorsResult(d.competitors_analysis);
  }

  // Semantic
  if (d.semantic_expansion) {
    var extra = d.semantic_expansion.total_keywords ? ' (' + d.semantic_expansion.total_keywords + ' ключових слів)' : '';
    showResultSuccess('semanticResult', 'Семантичне ядро' + extra, d.semantic_expansion.spreadsheet_url);
    if (d.semantic_expansion.spreadsheet_url) stepData.phase1Results.semantic = d.semantic_expansion.spreadsheet_url;
  }
}

// =========================================
// PHASE 2 LAUNCHES
// =========================================
function launchMetrics() {
  var url = document.getElementById('fMetUrl').value.trim();
  if (!url || !url.includes('docs.google.com/spreadsheets')) {
    showResultError('metricsResult', 'Вкажіть коректне посилання на Google таблицю'); return;
  }
  var sid = extractSpreadsheetId(url);
  if (!sid) { showResultError('metricsResult', 'Не вдалося отримати ID таблиці'); return; }

  var btn = document.getElementById('btnMetrics');
  btn.disabled = true; btn.classList.add('btn-loading');
  showResultLoading('metricsResult', 'Отримання метрик...');

  google.script.run
    .withSuccessHandler(function(r) {
      btn.disabled = false; btn.classList.remove('btn-loading');
      if (r.success) {
        var ex = r.totalKeywords ? ' (' + r.totalKeywords + ' ключових слів)' : '';
        showResultSuccess('metricsResult', 'Метрики отримано' + ex, r.spreadsheetUrl);
      } else { showResultError('metricsResult', r.error || 'Помилка'); }
    })
    .withFailureHandler(function(e) {
      btn.disabled = false; btn.classList.remove('btn-loading');
      showResultError('metricsResult', e.toString());
    })
    .submitGKPMetrics({
      source_spreadsheet_id: sid,
      doc_name: 'GKP Metrics - ' + new Date().toISOString().slice(0,10),
      language: document.getElementById('fMetLang').value,
      geo_target: document.getElementById('fMetGeo').value,
      manager_email: stepData.email
    });
}

function launchPageSpeed() {
  var url = document.getElementById('fPsUrl').value.trim();
  if (!url || !url.includes('docs.google.com/spreadsheets')) {
    showResultError('pagespeedResult', 'Вкажіть коректне посилання на Google таблицю'); return;
  }
  var btn = document.getElementById('btnPageSpeed');
  btn.disabled = true; btn.classList.add('btn-loading');
  showResultLoading('pagespeedResult', 'Тестування PageSpeed...');

  google.script.run
    .withSuccessHandler(function(r) {
      btn.disabled = false; btn.classList.remove('btn-loading');
      if (r.success) {
        var ex = r.totalUrls ? ' (' + r.totalUrls + ' URL)' : '';
        showResultSuccess('pagespeedResult', 'PageSpeed завершено' + ex, r.spreadsheetUrl);
      } else { showResultError('pagespeedResult', r.error || 'Помилка'); }
    })
    .withFailureHandler(function(e) {
      btn.disabled = false; btn.classList.remove('btn-loading');
      showResultError('pagespeedResult', e.toString());
    })
    .submitPageSpeedTest({
      spreadsheetUrl: url,
      testMobile: document.getElementById('optMobile').classList.contains('selected'),
      testDesktop: document.getElementById('optDesktop').classList.contains('selected'),
      manager_email: stepData.email
    });
}

function launchAI() {
  var url = document.getElementById('fAiUrl').value.trim();
  if (!url || !url.includes('docs.google.com/spreadsheets')) {
    showResultError('aiResult', 'Вкажіть коректне посилання на Google таблицю'); return;
  }
  var btn = document.getElementById('btnAI');
  btn.disabled = true; btn.classList.add('btn-loading');
  showResultLoading('aiResult', 'Генерація AI-звіту...');

  google.script.run
    .withSuccessHandler(function(r) {
      btn.disabled = false; btn.classList.remove('btn-loading');
      if (r.success) {
        var label = 'AI-звіт створено' + (r.domain ? ' (' + r.domain + ')' : '');
        showResultSuccess('aiResult', label, r.docUrl, 'doc-link');
      } else { showResultError('aiResult', r.error || 'Помилка'); }
    })
    .withFailureHandler(function(e) {
      btn.disabled = false; btn.classList.remove('btn-loading');
      showResultError('aiResult', e.toString());
    })
    .submitAIAnalysis(url);
}

function launchPDF() {
  var url = document.getElementById('fPdfUrl').value.trim();
  if (!url || !url.includes('drive.google.com')) {
    showResultError('pdfResult', 'Вкажіть коректне посилання на PDF (Google Drive)'); return;
  }
  var btn = document.getElementById('btnPDF');
  btn.disabled = true; btn.classList.add('btn-loading');
  showResultLoading('pdfResult', 'Парсинг PDF...');

  google.script.run
    .withSuccessHandler(function(r) {
      btn.disabled = false; btn.classList.remove('btn-loading');
      if (r.success) {
        var ex = r.totalSheets ? ' (' + r.totalSheets + ' вкладок)' : '';
        showResultSuccess('pdfResult', 'PDF оброблено' + ex, r.spreadsheetUrl);
      } else { showResultError('pdfResult', r.error || 'Помилка'); }
    })
    .withFailureHandler(function(e) {
      btn.disabled = false; btn.classList.remove('btn-loading');
      showResultError('pdfResult', e.toString());
    })
    .submitPdfAuditParse({ pdfUrl: url, manager_email: stepData.email });
}

// =========================================
// COMPETITORS TAGS
// =========================================
document.getElementById('compInput').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') {
    e.preventDefault();
    if (this.value.trim()) { addComp(this.value); this.value = ''; }
  }
  if (e.key === 'Backspace' && this.value === '' && stepData.competitors.length > 0) {
    stepData.competitors.pop(); renderComps();
  }
});
document.getElementById('compInput').addEventListener('paste', function(e) {
  e.preventDefault();
  var text = (e.clipboardData || window.clipboardData).getData('text');
  text.split(/[\n,;]+/).forEach(function(s) { if (s.trim()) addComp(s); });
});
document.getElementById('compTagsWrap').addEventListener('click', function(e) {
  if (e.target.classList.contains('tag-remove')) {
    stepData.competitors.splice(parseInt(e.target.dataset.idx), 1);
    renderComps();
  }
});

function addComp(val) {
  var c = normalizeDomain(val);
  if (!c || stepData.competitors.indexOf(c) !== -1) return;
  stepData.competitors.push(c);
  renderComps();
}

function renderComps() {
  var wrap = document.getElementById('compTagsWrap');
  var input = document.getElementById('compInput');
  wrap.querySelectorAll('.tag').forEach(function(t) { t.remove(); });
  stepData.competitors.forEach(function(c, i) {
    var tag = document.createElement('span');
    tag.className = 'tag';
    tag.innerHTML = c + '<span class="tag-remove" data-idx="'+i+'">&times;</span>';
    wrap.insertBefore(tag, input);
  });
  var cnt = document.getElementById('compCount');
  cnt.textContent = stepData.competitors.length > 0 ? stepData.competitors.length + ' конкурентів додано' : '';
}

// =========================================
// UTILITY
// =========================================
function toggleOption(id) { document.getElementById(id).classList.toggle('selected'); }

function extractSpreadsheetId(url) {
  var m = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
  return m ? m[1] : null;
}

function copyToClipboard(url, btnEl) {
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(url).then(function() { showCopied(btnEl); }).catch(function() { fallbackCopy(url, btnEl); });
  } else { fallbackCopy(url, btnEl); }
}
function fallbackCopy(url, btnEl) {
  var ta = document.createElement('textarea');
  ta.value = url; ta.style.position = 'fixed'; ta.style.left = '-9999px';
  document.body.appendChild(ta); ta.select();
  try { document.execCommand('copy'); } catch(e) {}
  document.body.removeChild(ta); showCopied(btnEl);
}
function showCopied(btnEl) {
  btnEl.classList.add('copied');
  var orig = btnEl.innerHTML;
  btnEl.innerHTML = '<i class="ti ti-check"></i>';
  setTimeout(function() { btnEl.classList.remove('copied'); btnEl.innerHTML = orig; }, 2000);
}

// =========================================
// RESULT RENDERERS
// =========================================
function showResultSuccess(id, label, url, linkCls) {
  var el = document.getElementById(id);
  el.classList.remove('hidden');
  el.className = 'result-card success';
  if (url) {
    var cls = linkCls || '';
    el.innerHTML = '<div class="result-card-header"><i class="ti ti-circle-check"></i> ' + label + '</div>' +
      '<div class="result-link-row">' +
        '<a href="'+url+'" target="_blank" class="result-link '+cls+'"><i class="ti ti-external-link"></i> Відкрити</a>' +
        '<button class="copy-btn" onclick="copyToClipboard(\''+url.replace(/'/g,"\\'")+'\',this)" title="Скопіювати"><i class="ti ti-copy"></i></button>' +
      '</div>';
  } else {
    el.innerHTML = '<div class="result-card-header"><i class="ti ti-circle-check"></i> ' + label + ' — завершено</div>';
  }
}

function showResultError(id, msg) {
  var el = document.getElementById(id);
  el.classList.remove('hidden');
  el.className = 'result-card error';
  el.innerHTML = '<div class="result-card-header"><i class="ti ti-circle-x"></i> ' + msg + '</div>';
}

function showResultLoading(id, msg) {
  var el = document.getElementById(id);
  el.classList.remove('hidden');
  el.className = 'result-card loading';
  el.innerHTML = '<div class="result-card-header"><i class="ti ti-loader-2"></i> ' + msg + '</div>';
}

function hideResults(ids) {
  ids.forEach(function(id) {
    var el = document.getElementById(id);
    if (el) { el.classList.add('hidden'); el.className = 'result-card hidden'; el.innerHTML = ''; }
  });
}

function showCompetitorsResult(data) {
  var el = document.getElementById('competitorsResult');
  el.classList.remove('hidden');
  var ok = true;
  data.forEach(function(c) { if (c.status !== 'success') ok = false; });
  el.className = 'result-card ' + (ok ? 'success' : 'error');
  var html = '<div class="result-card-header"><i class="ti ti-'+(ok?'circle-check':'alert-triangle')+'"></i> Конкуренти: '+data.length+' доменів</div>';
  data.forEach(function(c) {
    html += '<div class="competitor-result-item"><span class="detail-dot '+c.status+'"></span> '+c.domain;
    if (c.status === 'success' && c.spreadsheet_url) {
      html += ' — <a href="'+c.spreadsheet_url+'" target="_blank">таблиця</a>';
      html += ' <button class="copy-btn" onclick="copyToClipboard(\''+c.spreadsheet_url.replace(/'/g,"\\'")+'\',this)"><i class="ti ti-copy"></i></button>';
    }
    html += '</div>';
  });
  el.innerHTML = html;
}

// =========================================
// ENTER KEY HANDLERS
// =========================================
document.getElementById('fEmail').addEventListener('keypress', function(e) { if (e.key === 'Enter') nextStep(); });
document.getElementById('fDomain').addEventListener('keypress', function(e) { if (e.key === 'Enter') nextStep(); });
document.getElementById('fSemUrl').addEventListener('keypress', function(e) { if (e.key === 'Enter') nextStep(); });
document.getElementById('fMetUrl').addEventListener('keypress', function(e) { if (e.key === 'Enter') launchMetrics(); });
document.getElementById('fPsUrl').addEventListener('keypress', function(e) { if (e.key === 'Enter') launchPageSpeed(); });
document.getElementById('fAiUrl').addEventListener('keypress', function(e) { if (e.key === 'Enter') launchAI(); });
document.getElementById('fPdfUrl').addEventListener('keypress', function(e) { if (e.key === 'Enter') launchPDF(); });

// =========================================
// INIT
// =========================================
updateNav();
document.getElementById('fEmail').focus();
</script>
</body>
</html>
